# Highload-Yandex-Food

## Содержание:
* ### [1. Тема и аудитория](#1)
* ### [2. Расчет нагрузки](#2)
* ### [3. Глобальная балансировка](#3)
* ### [4. Локальная балансировка нагрузки](#4)
* ### [5. Логическая схема БД](#5)
* ### [6. Физическая схема БД](#6)
* ### [7. Алгоритмы](#7)
* ### [8. Технологии](#8)
* ### [9. Схема проекта](#9)
* ### [10. Обеспечение надежности](#10)
* ### [11. Расчет ресурсов](#11)


## 1. Тема и аудитория: <a name="1"></a>
### Тема
**Яндекс Еда** — сервис заказа быстрой доставки еды из ресторанов и продуктов из магазинов через мобильные приложения или веб-сайт.

### Аудитория
* [Мужчины и женщины от 18 до 55 лет из России.]([https://www.similarweb.com/ru/website/eda.yandex/#demographics](https://yandex.ru/project/eda/itogigoda))
* [MAU: в месяц 15 млн.]([https://www.similarweb.com/ru/website/eda.yandex/#ranking](https://yandex.ru/project/eda/itogigoda))
* [Среднее время нахождение на сайте пользователем 11 минут]([https://www.similarweb.com/ru/website/eda.yandex/#ranking](https://yandex.ru/project/eda/itogigoda))

### Продуктовый функционал
* Регистрация и авторизация
* Поиск (рестораны, категории, блюда)
* Отслеживание заказа (просмотр, отслеживание, оценивание)
* Добавление ресторана (создание, загрузка блюд)
* Возможность оплаты заказа онлайн
* Основная лента с продуктами и промокодами

### Ключевые особенности:
* Просмотр карты с ресторанами и их рейтинга
* Рейтинг самых популярных блюд

## 2. Расчет нагрузки <a name="2"></a>

### Продуктовые метрики

* Месячная аудитория 15 млн
* Дневная аудитория 3,5 млн
* 250 тысяч заказов в день

#### Усредненные метрики

1. Регистрация:

```
Аудитория Яндекс еды выросла на 42% за прошедший год
   
Аудитория в 2023 году - 15 млн, в 2022 на 42% меньше, ~8,7 млн
   
Прирост аудитории за год - 6,3 млн
   
RPS: 6,3*10^6 зап / (365 д * 24 ч * 60 м * 60 с) = 0,2 зап / с
```
2. Авторизация:

```
Дневная аудитория Яндекс Еды: 3,5 млн

Среднее количество авторизаций в год около 2, далее продолжают использовать этот же аккаунт, не выходя
      
RPS: 3,5*10^6 * 2 зап / (365 д * 24 ч * 60 м * 60 с) = 0,22 зап / с
```
3. Поиск блюд или ресторанов:

```
Поиск блюд или ресторанов (в том числе конкретные блюда или поск внутри уже найденного ресторана)
люди осуществляют 2 раза в неделю (104 раза в год).

RPS: 3,5*10^6 * 104 зап / (365 д * 24 ч * 60 м * 60 с) = 11,5 зап / с
```

4. Создание заказа:

```
Каждый человек в среднем заказывает 2 заказа в неделю (104 раза в год), а его отдельные товары в среднем собирают с 4 разных страниц

RPS: 3,5*10^6 * 104 * 4 зап / (365 д * 24 ч * 60 м * 60 с) = 46,1 зап / с
```

5. Отслеживание заказа:

```
В среднем каждый второй человек интересуется, в каком состоянии сейчас его заказ, чтоб понимать, как скоро встречать курьера. (остальные просят оставить у двери или просят курьеров звонить)
Каждый человек в среднем заказывает 2 заказа в неделю (104 раза в год), но просматривает каждлый по 4-5 раз
Тогда среднее количество просмотра статуса заказа в год это 104 / 2 * 4,5 = 234

RPS: 3,5*10^6 * 234 зап / (365 д * 24 ч * 60 м * 60 с) = 26 зап / с
```

6. Оценивание заказа:

```
Каждый человек в среднем заказывает 2 заказа в неделю (104 раза в год), предложение оценить заказ выскакивает после каждого заказа, но оценивает примерно 40% пользователей

104 * 0,4 = 41,6

RPS: 3,5*10^6 * 41,6 зап / (365 д * 24 ч * 60 м * 60 с) = 4,6 зап / с
```

7. Добавление ресторана:

```
На данный момент в Яндекс Еде насчитывается около 6 тыс ресторанов, около 2 тяс были добавлены за последний год, но это касается не всех пользователей, а только владельцев ресторанов, которые составляют около 1%
   
RPS: 3,5*10^6*10^-3 * 2000 зап / (365 д * 24 ч * 60 м * 60 с) = 0,2 зап / с
```

8. Добавление блюд ресторана:

```
На данный момент в Яндекс Еде насчитывается около 6 тыс ресторанов, каждый из них добавляет или удаляет по 5 блюд каждую неделю (261 раз в году), но это касается не всех пользователей, а только владельцев ресторанов, которые составляют около 1%
   
RPS: 3,5*10^6*10^-3 * 261 * 6000 зап / (365 д * 24 ч * 60 м * 60 с) = 173,8 зап / с
```

9. Возможность оплаты заказа онлайн:
   
```
Сейчас почти 80% заказов оплачиваются онлайн
   
RPS: 3,5*10^6 * 0,8 * 52 зап / (365 д * 24 ч * 60 м * 60 с) = 4,6 зап / с
```

10. Основная лента с продуктами и промокодами

```
Это начальная страница, на которой окажется каждый, кто воспользуется приложением, в среднем заходят 6 раз в неделю (312 раз в год)
   
RPS: 3,5*10^6 *312 зап / (365 д * 24 ч * 60 м * 60 с) = 34,6 зап / с
```

#### Сводная таблица RPS по типовым действиям

| №  | Действие                        |  Тип   |   RPS    | RPD (x86400) |
|:--:|---------------------------------|:------:|:--------:|:------------:|
| 1  | Регистрация                     | Запись |   0,2    |   17,2 тыс   |
| 2  | Авторизация                     | Чтение |   0,22   |     19 тыс   |
| 3  | Поиск блюд или ресторанов       | Чтение |   11,5   |      1 млн   |
| 4  | Создание заказа                 | Запись |   46,1   |    3,9 млн   |
| 5  | Отслеживание заказа             | Чтение |   26     |    2,2 млн   | 
| 6  | Оценивание заказа               | Запись |   4,6    |    390 тыс   |
| 7  | Добавление ресторана            | Запись |   0,2    |   17,2 тыс   |
| 8  | Добавление блюд ресторана       | Запись |   173,8  |     15 млн   |
| 9  | Возможность оплаты заказа онлайн| Чтение |   4,6    |    400 тыс   |
| 10 | Основная лента с продуктами     | Чтение |   34,6   |    2,9 млн   |

### Технические метрики

**Информация о продукте**

```
id: 16 байт (UUID);
Картинки: 25 Мб в среднем (3-4 фото + иногда короткое видео в сжатом виде)
Текст: Примем, что в среднем описании 3-4 поля содержат по 50 символов, но их размер несравним с картинками
id ресторана: 16 байт (UUID);

Итого: ~25 Мб
```

**Информация о комментарии**

```
id: 16 байт (UUID);
Текст: Примем, что в среднем 1 комментарий содержит 50 символов. 
       1 символ в Unicode кодируется 2 байтами.
Дата создания: 4 байта (timestamp)
id поста: 16 байт (UUID);

Итого: 16 + 50*2 + 4 + 16 = 136 б
```

**Информация о ресторане**

```
id: 16 байт (UUID);
Текст: Примем, что в среднем 1 описание содержит 200 символов. 
       1 символ в Unicode кодируется 2 байтами.
Вложение: 5 Мб в среднем (1 фото)
Комментарии: в среднем 150 штук по 136 б

Ресторан без фотографии: 16 + 150*2 + 4 + 4 = 324 б
Ресторан с фотографией: 5 Мб
```

С момента создания Яндекс еды прошло 8 лет. С того момента было зарегистрировано 100 млн аккаунтов.

1. Создание комментариев:

```
Дневная аудитория 3,5 млн.
В среднем оценивает заказ 40% пользователей, а делают их в среднем 2 раза в неделю
    
Общий объем памяти в день: 3,5*10^6*0,4 * 2 / 7 дней * 136 б = 6,4 Мб / д
Общий объем памяти за квартал: 6,4 Мб / д * 30 д * 3 = 0,5 Гб
Общий объем памяти за год: 6,4 Мб / д * 365 д = 2,3 Гб
Общий объем памяти за все время: 2,3 Гб * 8 г = 18,4 Гб
```

2. Создание закзов:

```
В среднем пользователь просматривает 2-3 ресторана за заказ и просматривает 30% всех блюд ресторана, а заказывает около 2 раз в неделю, тогда:

Общий объем памяти в день: 3,5*10^6 * 2 / 7 дней * 25Мб * 100 = 2475 Тб / д
Общий объем памяти за квартал: 2475 Тб / д * 30 д * 3 мес = 219,5 Пб
Общий объем памяти за год: 2475 Тб / д * 365 д = 78 Эб
Общий объем памяти за все время: 78 Эб * 8 л = 624 Эб

```

3. Профили пользователей:

```
Общий объем хранилица: 100*10^6 акк * 50 Кб = 5 Тб
Общий объем памяти за год: 5 Тб / 8 л = 0,15 Тб
Общий объем памяти за квартал: 78 Гб
```

#### Сводная таблица объема памяти по типовым действиям

| № | Действие                        | Объем памяти за все время | Объем памяти за квартал | Объем памяти за год |
|:-:|---------------------------------|:-------------------------:|:-----------------------:|:-------------------:|
| 1 | Создание комментариев           |           18,4 Гб         |         0,5 Гб          |       2,3 Гб        |
| 2 | Создание блюд                   |           624 Эб          |         219,5 Пб        |       78 Эб         |
| 3 | Профили пользователей           |           5 Тб            |         78 Гб           |       0,15 Тб       |

### Сетевой трафик

1. Регистрация:

```
0,2 * 50 Кб = 10 Кб/с
```

2. Авторизация:

```
0,22 * 50,4 Кб = 11 Кб/с
```

3. Добавление блюд:
   
```
173,8 * 25 Мб = 4,4 Гб/с
```

4. Создание заказов:
   
```
46,1 * 25 Мб = 1,1 Гб/с
```

5. Оценка заказов:
   
```
4,6 * 5Мб = 23 Мб/с
```

6. Поиск блюд:
   
```
11,5 * 25 Мб * 5 = 1,2 Гб/с
```

7. Оплата заказов:
    
```
4,6 * 1 Мб = 4,6 Мб/с
```

8. Просмотр основной ленты:
    
```
34,6 * 25 Мб * 10 = 8,7 Гб/с
```

[Пиковый трафик в 1,7 раз больше среднего](https://github.com/Antihoman/Highload-Yandex-Food/blob/main/img/timeline-cities.png)

| №  | Действие                        | Средний трафик | Пиковый трафик |
|:--:|---------------------------------|:--------------:|:--------------:|
| 1  | Регистрация                     |     10 Кб/с    |     17 Кб/с    |
| 2  | Авторизация                     |     11 Кб/с    |     19 Кб/с    |
| 3  | Добавление блюд                 |    4,4 Гб/с    |      8 Гб/с    |
| 4  | Создание заказов                |    1,1 Гб/с    |    1,8 Кб/с    |
| 5  | Оценка заказов                  |     23 Мб/с    |     40 Мб/с    |
| 6  | Поиск блюд                      |    1,2 Гб/с    |    1,9 Гб/с    |
| 7  | Оплата заказов                  |    4,6 Мб/с    |      8 Мб/с    |
| 8  | Просмотр основной ленты         |    8,7 Гб/с    |     15 Гб/с    |

---

## 3. Глобальная балансировка нагрузки <a name="3"></a>

### Расположение датацентров

Так как большая часть аудитории Яндекс Еды располагается в России, то все датацентры будут расположены на территории России.

Так как население России распределено неравномерно, нам потребуются расположить основную часть датацентров в европейской части страны,
но также будут установлены в южной части Сибири и Дальнего Востока.

Следовательно, были выбраны следующие города для установки датацентров:

* Москва
* Казань
* Волгоград

![Population_dencity](https://github.com/Antihoman/Highload-Yandex-Food/assets/91897029/a62af400-440d-4678-b9b6-0080b773b4b5)

### Глобальная балансировка 

С помощью GeoDNS будем определять физически ближайший к пользователю ЦОД. ЦОД-ы будут отвечать за следующие районы:

* Казань, Волгоград -> Европейская часть России
* Москва -> Москва, Московская область

Далее с помощью BGP Anycast определить для каждого района свой ЦОД, чтоб улучшить балансировку.

---

## 4. Локальная балансировка нагрузки <a name="4"></a>

BGP балансировка:
В ДЦ будет стоять маршрутизаторы, с помощью BGP маршрутизации будет распределять данные на балансировщик L7.
Возможные аналоги RIP и OSPF - более простые в настройке, но не такие гибкие как BGP.
BGP позволяет определить, что определенные типы трафика должны направляться через определенный маршрут или группу маршрутов к балансировщику.

Для обеспечения отказоустойчивости в случае падения одной из нод, будем использовать программное обеспечение
keepalived с использованием протокола VRRP. Это позволит мониторить доступность нод, а в случае отказа одной
из них перенаправить трафик на другую ноду.

На уровне L7 будем использовать балансировщик Envoy, поскольку он поддерживает gRPC, разрабатывался
для поддержания микросервисных архитектур, и является мощным инструментом для балансировки нагрузки.
Envoy будет смотреть на текущее количество сессий у конкретного сервера и отправлять запрос на сервер с наименьшим количеством их - это удобно для обработки долгих запросов.

Также будет использован k8s для решения проблемы отказоустойчивости, а именно с использованием Liveness и Readliness probe, разницы между ними почти нет, но один используется для проверху "жив" ли сервер, а другой - готов ли принимать сообщения.

---

## 5. Логическая схема БД <a name="5"></a>

![image](https://github.com/Antihoman/Highload-Yandex-Food/assets/91897029/c6a8b327-42ed-4543-bd37-1cfc7584ca17)

---

## 6. Физическая схема БД <a name="6"></a>

### Выбор СУБД

Для хранения сессий пользователей (`user_session`) будем использовать key-value хранилище Redis. За счет своей высокой
производительности, отказоустойчивости и широкого распространения можем смело на него полагаться.

Таблицы (`user`, `dish`, `order`, `restaurant`, `review`, `courier`) положим в MongoDB. Данные в ней хранятся не в реляционном формате, а в виде
документов в формате json, что делает её крайне гибкой и упрощает адаптацию к требованиям.

Для хранения медиа (`photo`) выберем CEPH. В отличие от облачных хранилищ данных, не требует
стабильного подключения к сети, обладает высокой масштабируемостью и надежностью. Это программно определяемая
распределенная файловая система с открытым исходным кодом, лишенная узких мест и единых точек отказа, которая
представляет из себя легко масштабируемый до петабайтных размеров кластер узлов, выполняющих различные функции,
обеспечивая хранение и репликацию данных, а также распределение нагрузки, что гарантирует высокую доступность и
надежность. Никакого специального оборудования не требуется.

Также  таблиц (`dish_seaarch`, `restaurant_search`, `favorite_restaurant`, `favorite_dish`) можно положить в ХД ElasticSearch. Оно предоставляет механизм
для поиска, анализа и хранения данных в реальном времени. Elasticsearch используется для индексации и поиска различных
типов информации, например, текстовых данных. Очень хорошо горизонтально масштабируется добавлением новых узлов в
кластер.

В качестве СУБД для сбора и анализа метрик возьмем ClickHouse в нее добавим таблицы (`review`, `courier_rating`, `restaurant_rating`, `favorite_dish`, `favorite_restaurant`). Это колончатая база данных, что позволяет эффективно
сжимать данные и быстро выполнять запросы. Поддерживает распределенное выполнение запросов. Использует движок
MergeTree, что позволяет с высокой производительностью выполнять аналитические запросы, поддерживает индексирование,
репликацию и партиционирование данных, горизонтальное масштабирование (Prometheus рассчитан на вертикальное).
Здесь будут храниться метрики.

### Клиентские библиотеки

Основной язык - Go, поэтому для подключения к СУБД будем использовать следующие библиотеки:

Для подключения MongoDB: [официальный драйвр](https://www.mongodb.com/docs/drivers/go/current/)

Для подключения Redis: `go-redis`

Для подключения CEPH: `go-ceph`

Для подключения ElasticSearch: `olivere/elastic`

Для подключения ClickHouse: `clickhouse-go`

### Индексы

`user`: hash по user_id

`user_session`: hash по session_id

`order`: hash по order_id

`dish`: hash по dish_id

`restaurant`: hash по restaurant_id

`discount`: hash по discount_id

`courier`: hash по courier_id

`photo`: hash по photo_id

`review`: hash по review_id

`favorite_dish`: hash по favorite_id

`favorite_restaurant`: hash по favorite_id

### Шардинг

Для шардинга выберем самые нагруженные таблицы:

`user`: по user_id

`order`: по order_id

`dish`: по restaurant_id

`review`: по user_id

`restaurant`: по restaurant_id

`photo`: по user_id, dish_id, restaurant_id, courier_id 

---

## 7. Алгоритмы <a name="7"></a>

### Лента

Лента пользователя будет состоять из ресторанов: избранных, популярных(с высокой оценкой) и оплативших рекламу

Лента пользователя внутри выбранного ресторана будет состоять из блюд: избранных, популярных, рекламных и закзанных ранее этим пользователем
Пример схемы лент:

![image](https://github.com/Antihoman/Highload-Yandex-Food/assets/91897029/852d4449-01c9-4c8d-aa4a-622bef251bc3)

### Поиск

Для эффективного поиска ресторанов и поиска по блюдам будем использовать движок ElasticSearch. Это
мощный и гибкий поисковый и аналитический движок, который основан на технологии поиска по тексту.

- `restaurant`
    * `text` - частичное совпадение, допускаются различные формы слов, будет использоваться максимально подробный поиск: префиксный, постфиксный 

- `plate`
    * `text` - частичное совпадение, допускаются различные формы слов, будет использоваться максимально подробный поиск: префиксный, постфиксный

Поиск по ресторанам будет также представлять из себя блочный алгоритм, по подобию ленты

Поиск по блюдам будет отдавать приоритет блюдам с наибольшей оценкой, а также заказывалось ли оно ранее.

### Подборка курьера

Для эфективного поиска близжайших курьеров будет расчитываться время маршрута между двумя координатами (ресторана и самого курьера) и сортироваться по близжайшему, естественно курьер должен быть не на заказе и при отказе, заказ передается следующему в списке

Будет использовано: Haversine formula и Vincenty formula, а также геоиндексирование

### Модерация

Клиент всегда может связаться в чате с модерацией для уточнения информации о заказе или высказывания притензий, модераторы могут выдавать промокоды на скидку следующего заказа для компенсирования неудобства

---

## 8. Технологии <a name="8"></a>

### Бэкенд

Для бэкенда будем использовать язык `golang`, как простой язык с поддержкой многопоточности с огромным количеством
готовых библиотек. Сервис будет выполнен в формате микросервисной архитектуры. Она повышает отказоустойчивость и
разделяет сервис на логические блоки.

### БД и кэш

В качестве кэш хранилища взяли Redis. Имеет больше функциональных возможностей по сравнению с конкурентами (например,
memcached) - поддержку транзакций, очереди, а также поддерживает master-slave репликацию и кластеризацию.

В роли основной БД выступает MongoDB. Данные в ней хранятся не в реляционном формате, а в виде документов в формате
json, что делает её крайне гибкой и упрощает адаптацию к требованиям.

* Скорость – специфическая структура и поддержка индексации хорошо сказываются на производительности системы, так что её
  имеет смысл использовать там, где скорость имеет критическое значение;
* Удобство масштабирования – MongoDB весьма ценят в небольших быстро развивающихся компаниях, потому что при
  необходимости её можно без особых сложностей масштабировать и менять в зависимости от потребностей бизнеса. Для того,
  чтобы, например, добавить новое поле, не приходится радикально менять структуру всей базы;
* Функция работы на нескольких серверах – MongoDB использует механизмы репликации и сегментирования, позволяющие
  формировать функциональные копии БД, которым можно в любой момент делегировать управление, и равномерно распределять
  между ними нагрузку.

### Хранилище

Для хранения медиа выбрали CEPH. В отличие от облачных хранилищ данных, не требует стабильного подключения к сети,
обладает высокой масштабируемостью и надежностью. Это программно определяемая распределенная файловая система с открытым
исходным кодом, лишенная узких мест и единых точек отказа, которая представляет из себя легко масштабируемый до
петабайтных размеров кластер узлов, выполняющих различные функции, обеспечивая хранение и репликацию данных, а также
распределение нагрузки, что гарантирует высокую доступность и надежность. Никакого специального оборудования не
требуется.

**Протоколы для работы с CEPH:**

RADOS: Ceph использует Reliable Autonomic Distributed Object Store (RADOS) для хранения данных.
RADOS - это объектная система хранения, которая позволяет хранить данные в виде объектов вместо блоков или файлов.
Она обеспечивает высокую доступность, масштабируемость и надежность.

RBD: Ceph также поддерживает RADOS Block Device (RBD), который позволяет создавать виртуальные блочные устройства на
основе объектов RADOS. Эти устройства могут быть монтированы в системе как обычные диски, что позволяет использовать
их для хранения медиафайлов. Программный интерфейс RBD позволяет работать с этими устройствами в режиме чтения/записи
и выполнять служебные операции — изменение размера, клонирование, создание и возврат к снимку состояния итд.

### Медиа

Для сжатия и передачи видео и фото в базе данных можно использовать следующие протоколы и методы:

Сжатие с потерями: Это метод, который основывается на несовершенстве человеческого слуха и зрения при восприятии звуковой и изобразительной информации. Он использует эффект маскировки, который зависит от спектральных и временных характеристик маскируемого и маскирующего сигналов.

Временное и пространственное сжатие: Временное сжатие производится поиск различий между кадрами и записывается только различающаяся информация, то есть кадры описываются на основе отличия от предыдущего кадра. Пространственное сжатие применяется к данным одного кадра, независимо от содержимого соседних кадров.
Протоколы передачи данных:

Передача чанков может происходить в разных форматах и разных разрешениях для наилучшей доступности и скорости передачи.

### Метрики

В качестве СУБД для сбора и анализа метрик возьмем ClickHouse. Это колончатая база данных, что позволяет эффективно
сжимать данные и быстро выполнять запросы. Поддерживает распределенное выполнение запросов. Использует движок
MergeTree, что позволяет с высокой производительностью выполнять аналитические запросы, поддерживает индексирование,
репликацию и партиционирование данных, горизонтальное масштабирование (Prometheus рассчитан на вертикальное).

### Поиск

Для различного рода поиска используем ElasticSearch. Это - ХД для поиска, анализа и хранения данных в реальном времени.
Elasticsearch используется для индексации и поиска различных типов информации, например, текстовых данных. Очень хорошо
горизонтально масштабируется добавлением новых узлов в кластер.

### Балансировщик

В качестве баланировщика L4 используем nginx. Благодаря нему трафик будет эффективно балансироваться по разным серверам.

На уровне L7 будем использовать балансировщик и прокси Envoy, поскольку он поддерживает gRPC, разрабатывался
для поддержания микросервисных архитектур, и является мощным инструментом для балансировки нагрузки.

### Фронтенд

Для фронтенда будут использоватся такие языки, как HTML, CSS, TypeScript. Статическая типизация помогает выявлять ошибки
на этапе компиляции, а не во время выполнения, как это обычно происходит в JavaScript.

TypeScript поддерживает новые функции ECMAScript, что позволяет разработчикам использовать новые возможности JavaScript
до того, как они станут стандартом.

TypeScript поддерживает модульность, что позволяет разработчикам разбивать код на множество файлов и модулей, упрощая
тем самым его поддержку и тестирование.

---

## 9. Схема проекта <a name="9"></a>

![image](https://github.com/Antihoman/Highload-Yandex-Food/assets/91897029/f4b9222a-48c0-406a-b2e4-4f7939d8571d)

---

## 10. Обеспечение надежности <a name="10"></a>

### Резервирование

* Наличие резервных серверов, дисков и другого оборудования, готового взять на себя нагрузку в случае сбоя основных
  компонентов.
* Резервирование ДЦ: наличие нескольких географически распределенных центров обработки данных, способных обслуживать
  систему в случае отказа основного центра.
* Резервирование БД - репликация: использование репликации баз данных позволяет создавать резервные копии данных и
  обеспечивать доступ к данным в случае отказа основной базы данных + распределение по шардам.
* Расчеты пикового трафика и размера хранения с запасом.

### Failover policy

* Автоматическое выполнение повторных запросов к некорректным компонентам для повышения вероятности успешной обработки
  запроса.
* Уменьшение запросов на проблемный хост: в случае временной недоступности какого-либо сервиса, система автоматически
  уменьшает количество запросов на этот компонент, чтобы избежать возможной нагрузки и предотвратить негативное влияние
  на производительность системы.

### Graceful shutdown

Позволит системе закрыть все активные соединения, завершить обработку текущих задач и корректно освобождить ресурсы,
прежде чем завершить работу -> уменьшается фон ошибок.

### Graceful degradation

Обеспечивает то, что наше приложение будет продолжать корректно работать для пользователей, у которых отключены
некоторые функциональные возможности или использовано устаревшее оборудование или программное обеспечение.
Основные функции приложения работают всегда.
Мы не должны зависеть на 100% от функций с наименьшим приоритетом.
Примеры: При проблеме с бд при подборе ресторана, можно отображать не все возможные, а лишь 5 первых или временно заморозить рейтинги ресторанов, не обновлять в реальном времени

### Observability

* Логирование - записи информации о действиях и событиях, происходящих в программном обеспечении.
* Мониторинг - отслеживание состояния системы.
    * RUM для мониторинга действий пользователя внутри системы
    * Synthetic monitoring для отслеживания времени безотказной работы приложения, latency
    * External monitoring для публичного независимого health-check сервиса
* Профилирование - сбор статистики о работе сервиса (профилировщик go - pprof)

---

## 11. Расчет ресурсов <a name="11"></a>

* Дневная аудитория - 3,5 млн. Каждый человек заходит примерно 2 раза в неделю.
* Умножим на пиковый коэффициент 1.67.

| Сервис    | Пиковый RPS | CPU  |  RAM   |     Net     |
|-----------|:------------|:----:|:------:|:-----------:|
| Auth      | 2           | 0,02 |  2 Мб  |  2 Мбит/с   |
| Profile   | 6           | 0,06 |  6 Мб  | 2,3 Мбит/с  |
| Restaurant| 300         | 3    |  3 Гб  | 7,5 Гбит/с  |
| Dish      | 15          | 0,15 | 15 Мб  |  6 Мбит/с   |
| Comment   | 10          | 0,1  | 10 Мб  | 3,3 Мбит/с  |

| Сервис    | Хостинг | Конфигурация                                                              | Cores | Cnt | Покупка, $ | Аренда, $ |
|-----------|---------|---------------------------------------------------------------------------|-------|-----|------------|-----------|
| Auth      | own     | A2SDi-8C-HLN4F-8-Core C3758 Atom/2x 4GB 2400MHz DDR4/CyberServe Atom-104i | 8     | 8   | 4500       | 50        |
| Profile   | own     | A2SDi-8C-HLN4F-8-Core C3758 Atom/2x 4GB 2400MHz DDR4/CyberServe Atom-104i | 8     | 2   | 4500       | 50        |
| Restaurant| own     | 2x6338/16x32GB/2xNVMe4T/2x25Gb/s                                          | 256   | 40  | 10 000     | 167       |
| Dish      | own     | 2x6338/16x32GB/2xNVMe4T/2x25Gb/s                                          | 64    | 110 | 10 000     | 167       |
| Comment   | own     | 2x6434/4x4GB/1xNVMe256Gb/2x1Gb/s                                          | 64    | 24  | 6 000      | 80        |

Беру минимум два сервера на случай отказа одного из них.

Посчитаем затраты на приобретение серверов:

**Покупка, $**

4500 * 8 + 4500 * 2 + 10000 * 40 + 10000 * 110 + 6000 * 24 = 1 689 000 $

С момента создания Яндекс еды прошло 6 лет.

Если делать замену через ~10 лет, то стоимость выйдет 1 689 000 $ 

**Аренда, $**

С момента создания Яндекс еды прошло 6 лет.

(50 * 8 + 50 * 2 + 167 * 40 + 167 * 110 + 80 * 24) * 12 * 6 = 1 977 840 $

Итого: покупать сервера выходит меньше по стоимости, чем аренда.
